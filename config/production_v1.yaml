# =============================================================================
# PRODUCTION MODEL CONFIGURATION v1.0
# =============================================================================
# Based on analysis of 18 ablation experiments
# Best performer: 06_No_DC configuration with enhancements
#
# Key optimizations:
#   1. global_scale normalization (preserves CBF amplitude - CRITICAL)
#   2. dc_weight=0.0 (physics constraint hurts performance)
#   3. Rician noise (MRI-correct physics)
#   4. Wide SNR range [2, 25] for robustness
#   5. 5-model ensemble for stability
#   6. Extended training (200 epochs)
#   7. Larger dataset (500k samples)
#   8. Domain randomization for generalization
# =============================================================================

# --- MODEL ARCHITECTURE ---
training:
  model_class_name: SpatialASLNet      # U-Net architecture (proven winner)
  # Alternative: DualEncoderSpatialASLNet  # Y-Net with separate PCASL/VSASL streams

  # Network capacity
  hidden_sizes: [32, 64, 128, 256]     # Standard U-Net pyramid
  dropout_rate: 0.1                     # Regularization
  norm_type: group                      # GroupNorm (no train/eval mismatch)

  # Loss configuration - CRITICAL SETTINGS
  loss_type: l1                         # MAE loss (forces accurate predictions)
  dc_weight: 0.0                        # NO physics constraint (hurts performance)
  variance_weight: 0.1                  # Prevents mean-collapse

  # Target scaling
  att_scale: 0.033                      # Normalize ATT to similar magnitude as CBF
  cbf_weight: 1.0                       # Equal weighting
  att_weight: 1.0

  # Uncertainty bounds
  log_var_cbf_min: -5.0
  log_var_cbf_max: 10.0
  log_var_att_min: -5.0
  log_var_att_max: 14.0

  # Training parameters
  learning_rate: 0.0001                 # Adam default
  weight_decay: 0.0001                  # L2 regularization
  batch_size: 32                        # Spatial batches (memory limited)
  n_epochs: 200                         # Extended training
  n_ensembles: 5                        # 5-model ensemble for robustness

  # Early stopping
  early_stopping_patience: 25           # More patience for production
  early_stopping_min_delta: 0.0
  validation_steps_per_epoch: 50        # More validation samples

# --- DATA CONFIGURATION ---
data:
  use_offline_dataset: true
  offline_dataset_path: asl_spatial_dataset_500k    # Large production dataset
  num_samples_to_load: 500000                       # 500k samples

  # PLD values (ms) - standard MULTIVERSE protocol
  pld_values: [500, 1000, 1500, 2000, 2500, 3000]

  # CRITICAL: Normalization mode
  # global_scale preserves CBF amplitude information
  # per_curve (z-score) DESTROYS CBF information - DO NOT USE
  normalization_mode: global_scale
  global_scale_factor: 10.0

  # Noise model
  noise_type: rician                    # MRI-correct magnitude noise

  # Active noise components for realistic training
  data_noise_components:
    - thermal                           # Scanner thermal noise
    - physio                            # Physiological oscillations
    - drift                             # Scanner drift

# --- NOISE ENGINE CONFIGURATION ---
noise_config:
  # Wide SNR range for robustness to clinical variability
  snr_range: [2.0, 25.0]                # Covers pathology (low) to optimal (high)

  # Physiological noise (cardiac/respiratory)
  physio_amp_range: [0.03, 0.15]        # 3-15% amplitude
  physio_freq_range: [0.5, 2.0]         # 0.5-2 Hz (cardiac/resp)

  # Scanner drift
  drift_range: [-0.03, 0.03]            # ±3% drift

  # Motion spikes (occasional artifacts)
  spike_probability: 0.02               # 2% chance per sample
  spike_magnitude_range: [2.0, 5.0]     # 2-5x signal

# --- PHYSICS PARAMETERS ---
simulation:
  T1_artery: 1850.0                     # Blood T1 at 3T (ms)
  T_tau: 1800.0                         # Label duration (ms)
  alpha_PCASL: 0.85                     # PCASL labeling efficiency
  alpha_VSASL: 0.56                     # VSASL labeling efficiency
  T2_factor: 1.0                        # T2 decay factor
  alpha_BS1: 1.0                        # Background suppression

  # Domain randomization for generalization
  domain_randomization:
    enabled: true
    T1_artery_range: [1550.0, 2150.0]   # Hematocrit variation
    alpha_PCASL_range: [0.75, 0.95]     # Labeling efficiency variation
    alpha_VSASL_range: [0.40, 0.70]     # VSS efficiency variation
    T_tau_perturb: 0.10                 # ±10% label duration

# --- LOGGING ---
wandb:
  wandb_project: asl-production-v1
  wandb_entity: adikondepudi

# --- METADATA ---
_experiment:
  name: production_v1
  description: Full production model with all optimizations
  hypothesis: Combine best settings from ablation studies for maximum performance
