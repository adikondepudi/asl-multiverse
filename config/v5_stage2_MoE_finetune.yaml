# FILE: config/v5_stage2_MoE_finetune.yaml
# Configuration for the v5 Mixture of Experts fine-tuning stage (Stage 2).
# Loads a pre-trained encoder, freezes it, and fine-tunes the MoE head.

training:
  model_class_name: "DisentangledASLNet"
  encoder_type: "physics_processor"
  
  # Architecture & Regularization for the head
  hidden_sizes: [512, 256, 128]
  dropout_rate: 0.0878
  weight_decay: 0.0000138
  log_var_reg_lambda: 0.05

  # Learning Rate & Production Scale Parameters
  learning_rate: 0.00005     # CRITICAL: Very low LR for fine-tuning
  batch_size: 8192
  n_ensembles: 5
  validation_steps_per_epoch: 10
  norm_type: "batch"
  n_epochs: 50               # Substantial run time, will use early stopping

  # Core Model/Loss Parameters for NLL Loss
  log_var_cbf_min: -5.0
  log_var_cbf_max: 7.0
  log_var_att_min: -5.0
  log_var_att_max: 14.0
  
  # Encoder architecture must match Stage 1
  transformer_d_model_focused: 32
  transformer_nhead_model: 4
  transformer_nlayers_model: 2

moe:
  num_experts: 4
  gating_dropout_rate: 0.1

data:
  use_offline_dataset: true
  offline_dataset_path: "asl_offline_dataset_10M_v3"
  pld_values: [500, 1000, 1500, 2000, 2500, 3000]
  num_samples: 1000000 

simulation:
  T1_artery: 1850.0
  T_tau: 1800.0
  T2_factor: 1.0
  alpha_BS1: 1.0
  alpha_PCASL: 0.85
  alpha_VSASL: 0.56

wandb:
  wandb_project: "asl-multiverse-prod-v5"
  wandb_entity: "adikondepudi"